<template><div><h2>Planner</h2><n-space align='center' :wrap='false'><n-date-picker v-model:value='range' type='daterange' /><n-select v-model:value='rotationKind' :options='rotationOptions' style='width: 220px' placeholder='Schema turni'/><n-button @click='load'>Carica</n-button><n-button tertiary @click='genRotation'>Genera</n-button><n-button type='primary' @click='publish'>Pubblica</n-button><n-button @click='exportCsv'>Export CSV</n-button><n-upload :default-upload='false' @change='importCsv'><n-button>Import CSV</n-button></n-upload></n-space><div style='margin-top:16px; overflow:auto'><table class='grid'><thead><tr><th>Dipendente</th><th v-for='d in days' :key='d'>{{ d }}</th></tr></thead><tbody><tr v-for='e in employees' :key='e.id'><td>{{ e.full_name }} <small>({{ e.company }})</small></td><td v-for='d in days' :key='e.id+"_"+d'><n-select size='small' :options='options' v-model:value='cell[e.id+"_"+d]' @update:value='v=>save(e.id,d,v)' /></td></tr></tbody></table></div></div></template>
<script setup lang='ts'>import { ref, computed } from 'vue'; import { NButton, NDatePicker, NSpace, NSelect, NUpload, useMessage } from 'naive-ui'; import api, { Employee, Shift, ScheduleEntry } from '../lib/api'; const message=useMessage(); const employees=ref<Employee[]>([]); const shifts=ref<Shift[]>([]); const range=ref<[number, number] | null>(null); const cell=ref<Record<string,string|null>>({}); const rotationKind=ref<string | null>('H24_4on2off'); const rotationOptions=[{ label:'8–17 (feriali)', value:'DAY_8_17' },{ label:'H16 4on/2off', value:'H16_4on2off' },{ label:'H24 4on/2off', value:'H24_4on2off' },{ label:'H16 7on/7off', value:'H16_7on7off' },{ label:'H24 7on/7off', value:'H24_7on7off' },]; const days=computed(()=>{ if(!range.value) return []; const d1=new Date(range.value[0]); const d2=new Date(range.value[1]); const out:string[]=[]; for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){ out.push(d.toISOString().slice(0,10)) } return out }); const options=computed(()=>[{ label:'—', value:null }, ...shifts.value.map(s=>({ label: `${s.name} (${s.start_hhmm}-${s.end_hhmm})`, value:s.code })), { label:'FERIE', value:'VACATION' }, { label:'PERMESSO', value:'PTO' }]); async function load(){ const [eRes, sRes] = await Promise.all([ api.get<Employee[]>('/employees'), api.get<Shift[]>('/shifts') ]); employees.value=eRes.data; shifts.value=sRes.data; if(range.value){ const [from,to]=[new Date(range.value[0]).toISOString().slice(0,10), new Date(range.value[1]).toISOString().slice(0,10)]; const { data }=await api.get<ScheduleEntry[]>('/schedule/entries', { params:{ range_start:from, range_end:to } }); cell.value={}; for(const e of data){ cell.value[`${e.employee_id}_${e.date}`]=e.leave_type ?? e.shift_code } } } async function save(empId:number, day:string, token:string|null){ await api.post('/schedule/entries', { employee_id:empId, date:day, shift_code: token && (token==='VACATION' || token==='PTO') ? null : token, leave_type: token && (token==='VACATION' || token==='PTO') ? token : null }) } async function publish(){ if(!range.value) return; const [from,to]=[new Date(range.value[0]).toISOString().slice(0,10), new Date(range.value[1]).toISOString().slice(0,10)]; const { data }=await api.post('/schedule/publish', { range_start:from, range_end:to, note:'Pubblicazione web' }); message.success(`Snapshot ${data.snapshot_id} creato. ${data.affected_employees.length} dipendenti notificati.`) } async function exportCsv(){ if(!range.value) return; const [from,to]=[new Date(range.value[0]).toISOString().slice(0,10), new Date(range.value[1]).toISOString().slice(0,10)]; const res=await api.get('/io/export.csv', { params:{ range_start:from, range_end:to }, responseType:'blob' }); const url=URL.createObjectURL(res.data); const a=document.createElement('a'); a.href=url; a.download=`schedule_${from}_${to}.csv`; a.click(); URL.revokeObjectURL(url) } async function importCsv({ file }: any){ const fd=new FormData(); fd.append('file', file.file as Blob, file.name); await api.post('/io/import.csv', fd); message.success('CSV importato'); await load() } async function genRotation(){ if(!range.value || !rotationKind.value) return; const [from,to]=[new Date(range.value[0]).toISOString().slice(0,10), new Date(range.value[1]).toISOString().slice(0,10)]; const ids=employees.value.map(e=>e.id); const { data }=await api.post('/rotation/generate', { employee_ids:ids, kind:rotationKind.value, range_start:from, range_end:to }); message.success(`Create/aggiornate ${data.created} assegnazioni`); await load() }
</script>
<style>.grid{border-collapse:collapse}.grid th,.grid td{border:1px solid #ddd;padding:6px 8px;white-space:nowrap}.grid thead th{position:sticky;top:0;background:#fafafa}</style>
